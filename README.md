# p5js-simple-vj-system

`p5js-simple-vj-system`は、p5.jsとTypeScriptで構築されたライブVJプレイグラウンドです。AKAI APC Mini MK2グリッドコントローラーをターゲットにしており、高速なシーン切り替え、スムーズなトグル操作、オーディオリアクティブなビジュアルに重点を置いています。

---

## 特徴
- Vite開発サーバー（TypeScript、ESLint、ホットリロード対応）
- APC Mini MK2（8列×8行）に最適化されたシーン選択とクロスフェード
- 瞬時値と0.2秒スムーズ値の両方を提供する7つのトグルチャンネル
- ブラウザのマイクモニターが各シーンに`audioLevel`値を提供
- `L`キーでデバッグモードを切り替え、スムーズなノイズで入力を置き換え
- `P`キーでトグル状態、オーディオ統計、列の詳細を表示するデバッグオーバーレイを表示

---

## 必要条件
- Node.js 18以上
- npm
- Web MIDI APIとgetUserMediaをサポートする最新のChromiumブラウザ

---

## セットアップ
1. 依存関係をインストール

   ```bash
   npm install
   ```

2. 開発サーバーを起動

   ```bash
   npm run dev
   ```

   表示されたURLをブラウザで開き、MIDIとマイクへのアクセスを許可してください。

3. ビルドとプレビュー

   ```bash
   npm run build
   npm run preview
   ```

---

## キーボードショートカット
- `1`–`8`: 各列に最初の行のシーンを割り当て（MIDIがない場合のフォールバック）
- `0`: アクティブな列のオーバーライドをクリア
- `Q`–`I`: 各列のシーンを循環（MIDIがない場合）
- `Z`–`M`: 7つのトグルチャンネルを切り替え
- `P`: デバッグオーバーレイを切り替え
- `L`: ライブマイク入力とデバッグノイズを切り替え
- `Enter`: BPMマネージャーのタップテンポ
- `Shift`: BPMマネージャーを開始し、シーンのビートタイマーをリセット
- `Space`: フルスクリーンを切り替え

---

## デバッグオーバーレイ
オーバーレイ（`P`で有効化）は以下を表示します：
- フレームレート、経過秒数、背景フェーダーの状態
- 瞬時値とスムーズ値のトグル値（`Z`–`M`）
- オーディオレベルと現在のソース（`microphone`または`debug noise`）
- 列の選択、フェーダーアルファ、アクティブなシーン名

`L`キーはマイクモニターをデバッグモードに切り替えます。有効な場合、オーバーレイは合成オーディオレベルを報告し続けるため、マイクなしでオーディオリアクティブなシーンをテストできます。

---

## オーディオパイプライン
- `src/audio/MicrophoneMonitor.ts`は`getUserMedia`を使用してオーディオをキャプチャし、RMS（時間領域）と64ビンのスペクトラム（周波数領域）を計算し、正規化された結果を共有します。
- 各フレームでスムーズなRMS値とスペクトラムを10秒間のリングバッファー（最大1200サンプル）にプッシュし、短期統計を構築します。
- 正規化のために、RMSとビンごとのスペクトラム値の両方について、ローリングウィンドウ全体で10パーセンタイル（ノイズフロア）と90パーセンタイル（天井）を計算します。フロアを引き、`(ceil - floor)`で割り、`[0, 1]`にクランプし、ウィンドウが空の場合は生の値にフォールバックします。
- 生のRMSとスペクトラムも指数的にスムーズ化され（アタックフレンドリー、ディケイ遅め）、ヒストリーに入る前にトランジェントを可視化しつつノイズが支配しないようにします。
- `SceneManager#update`はモニターから`audioLevel`、`audioSpectrum`、`audioDebug`を受け取り、`SceneDrawContext`で転送して、すべてのシーンが一貫して反応できるようにします。
- `src/scenes/audioSpectrum/AudioSpectrumScenes.ts`内のオーディオスペクトラムシーンは、正規化されたビンを読み取り、バー、波、放射状リングを形成します。他のシーンも同じデータを自由に再利用できます。
- デバッグモードが有効な場合（`L`を押す）、モニターは低周波数バイアスのノイズスペクトラムを合成し、同じ正規化パイプラインを通じてマイクダイナミクスを模倣します。

---

## シーンAPIの注意点
`SceneDrawContext`は以下のフィールドを提供します：

- `columnIndex`
- `elapsedSeconds`
- `deltaSeconds`
- `toggles`（瞬時値）
- `togglesSmooth`（0.2秒ブレンド値）
- `audioLevel`
- `audioDebug`
- `audioSpectrum`（64ビンの正規化スペクトラム）

トグルのヘルパー関数は`src/scenes/shared/toggleUtils.ts`にあります。補間値を読み取るには`mode: 'smooth'`を渡します。

---

## プロジェクト構成

```
src/
├─ main.ts
├─ audio/MicrophoneMonitor.ts
├─ core/
│  ├─ SceneManager.ts
│  ├─ SceneLibrary.ts
│  └─ IScene.ts
├─ input/KeyboardController.ts
├─ midi/
├─ rhythm/
└─ scenes/
```

---

## NPMスクリプト
- `npm run dev` – Vite開発サーバーを起動
- `npm run build` – 型チェックを実行し、プロダクションビルドを生成
- `npm run preview` – ローカルでプロダクションビルドをプレビュー

---

## ライセンス
ライセンスは提供されていません。このプロジェクトを基に独自の作業を配布または公開する予定がある場合は、`LICENSE`ファイルを追加してください。